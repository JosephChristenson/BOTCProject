<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Host</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div class="container">
        <div id="status" class="status info">Loading...</div>
        
        <div id="game-info" class="game-header" style="display: none;">
            <h1>Game name: <span id="gameName"></span></h1>
            <p>Host: <span id="hostName"></span></p>
            <div class="room-code" id="roomCode"></div>
            <p>Share this code with players to join your game</p>
        </div>

        <div id="share-section" class="share-section" style="display: none;">
            <h4>Share Game</h4>
            <p><strong>Room Code:</strong> <span id="shareRoomCode" class="room-code" style="font-size: 18px;"></span></p>
            <p><strong>Direct Link:</strong></p>
            <div class="share-link" id="shareLink"></div>
            <button onclick="copyToClipboard()" style="margin-top: 10px;">ðŸ“‹ Copy Link</button>
        </div>

        <div id="host-panel" style="display: none;">
            <div class="players-section">
                <h3>ðŸ‘¥ Connected Players (<span id="playerCount">0</span>)</h3>
                <div id="players-container" class="players-grid">
                    <div class="waiting-message">
                        <p>Waiting for players to join...</p>
                        <small>Share the room code above with your friends!</small>
                    </div>
                </div>
            </div>

            <div class="controls-section">
                <div class="control-panel">
                    <h3>ðŸŽ® Game Controls</h3>
                    <button class="success" onclick="startGame()" id="startBtn">Start Game</button>
                    <button class="warning" onclick="pauseGame()" id="pauseBtn" disabled>Pause Game</button>
                    <button class="danger" onclick="endGame()">End Game</button>
                    <div style="margin-top: 15px;">
                        <small>Game status: <span id="gameStatus">Waiting for players</span></small>
                    </div>
                </div>

                <div class="control-panel">
                    <h3>ðŸ’¬ Send Message</h3>
                    <div class="message-input">
                        <input type="text" id="messageInput" placeholder="Type message to players..." onkeypress="handleMessageKeyPress(event)">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                    <div style="margin-top: 10px;">
                        <button onclick="sendQuickMessage('Get ready!')" style="font-size: 12px;">Get Ready!</button>
                        <button onclick="sendQuickMessage('Good job everyone!')" style="font-size: 12px;">Good Job!</button>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <h3>ðŸ“‹ Activity Log</h3>
                <div id="actionLog" class="log"></div>
                <button onclick="clearLog()" style="margin-top: 10px;">Clear Log</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRoom = null;
        let gameStarted = false;
        let playersList = {};

        // Get room code from URL parameters
        function getRoomCodeFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('room');
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function initializeHostPanel(gameData) {
            currentRoom = gameData.roomCode;
            
            // Update game info display
            document.getElementById('gameName').textContent = gameData.gameName || 'Untitled Game';
            document.getElementById('hostName').textContent = gameData.hostName || 'Anonymous Host';
            document.getElementById('roomCode').textContent = gameData.roomCode;
            document.getElementById('shareRoomCode').textContent = gameData.roomCode;
            
            // Create share link
            const baseUrl = window.location.origin;
            const shareUrl = `${baseUrl}/player.html?room=${gameData.roomCode}`;
            document.getElementById('shareLink').textContent = shareUrl;
            
            // Show all sections
            document.getElementById('game-info').style.display = 'block';
            document.getElementById('share-section').style.display = 'block';
            document.getElementById('host-panel').style.display = 'block';
            
            addToLog(`Game created: ${gameData.gameName} (${gameData.roomCode})`, 'system');
            updateStatus('Game is ready! Waiting for players to join.', 'success');
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (message && currentRoom) {
                socket.emit('host-message', {
                    roomCode: currentRoom,
                    message: message
                });
                addToLog(`Message sent: "${message}"`, 'system');
                input.value = '';
            }
        }

        function sendQuickMessage(message) {
            if (currentRoom) {
                socket.emit('host-message', {
                    roomCode: currentRoom,
                    message: message
                });
                addToLog(`Quick message sent: "${message}"`, 'system');
            }
        }

        function handleMessageKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function startGame() {
            if (currentRoom && Object.keys(playersList).length > 0) {
                socket.emit('start-game', currentRoom);
                gameStarted = true;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('pauseBtn').disabled = false;
                document.getElementById('gameStatus').textContent = 'Game in progress';
                addToLog('Game started!', 'system');
                updateStatus('Game has started!', 'success');
            } else {
                updateStatus('Need at least 1 player to start the game', 'error');
            }
        }

        function pauseGame() {
            // Implement pause functionality
            addToLog('Game paused', 'system');
            updateStatus('Game paused', 'info');
        }

        function endGame() {
            if (confirm('Are you sure you want to end the game? All players will be disconnected.')) {
                addToLog('Game ended by host', 'system');
                updateStatus('Game ended', 'info');
                // Could emit end-game event to server
            }
        }

        function copyToClipboard() {
            const shareLink = document.getElementById('shareLink').textContent;
            navigator.clipboard.writeText(shareLink).then(() => {
                updateStatus('Link copied to clipboard!', 'success');
                setTimeout(() => {
                    updateStatus('Game is ready! Waiting for players to join.', 'success');
                }, 2000);
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = shareLink;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                updateStatus('Link copied to clipboard!', 'success');
            });
        }

        function addToLog(message, type = 'system') {
            const log = document.getElementById('actionLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            document.getElementById('actionLog').innerHTML = '';
            addToLog('Log cleared', 'system');
        }

        function updatePlayersDisplay(players) {
            const container = document.getElementById('players-container');
            const playerCount = Object.keys(players).length;
            
            playersList = players;
            document.getElementById('playerCount').textContent = playerCount;

            if (playerCount === 0) {
                container.innerHTML = `
                    <div class="waiting-message">
                        <p>Waiting for players to join...</p>
                        <small>Share the room code above with your friends!</small>
                    </div>
                `;
            } else {
                container.innerHTML = Object.values(players).map(player => `
                    <div class="player-card">
                        <h4>${player.name}</h4>
                        <p>ID: ${player.id.substring(0, 8)}...</p>
                        <p>Joined: ${new Date(player.joinedAt).toLocaleTimeString()}</p>
                    </div>
                `).join('');
            }

            // Enable/disable start button based on player count
            const startBtn = document.getElementById('startBtn');
            if (playerCount > 0 && !gameStarted) {
                startBtn.disabled = false;
                document.getElementById('gameStatus').textContent = 'Ready to start';
            }
        }

        // Socket event listeners
        socket.on('connect', () => {
            const roomCode = getRoomCodeFromURL();
            if (roomCode) {
                updateStatus('Connecting to your game room...', 'info');
                // Try to reconnect as host first
                socket.emit('reconnect-as-host', roomCode);
                // Also get room info as fallback
                socket.emit('get-room-info', roomCode);
            } else {
                // Redirect to lobby if no room code
                updateStatus('No room code found. Redirecting to lobby...', 'error');
                setTimeout(() => {
                    window.location.href = '/lobby.html';
                }, 2000);
            }
        });

        socket.on('disconnect', () => {
            updateStatus('Disconnected from server', 'error');
        });

        socket.on('host-reconnected', (roomInfo) => {
            initializeHostPanel({
                roomCode: roomInfo.roomCode,
                gameName: roomInfo.gameName,
                hostName: roomInfo.hostName
            });
            updatePlayersDisplay(roomInfo.players || {});
            
            if (roomInfo.gameStarted) {
                gameStarted = true;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('pauseBtn').disabled = false;
                document.getElementById('gameStatus').textContent = 'Game in progress';
            }
            
            addToLog('Reconnected to your game room', 'system');
        });

        socket.on('room-info', (roomInfo) => {
            const roomCode = getRoomCodeFromURL();
            initializeHostPanel({
                roomCode: roomCode,
                gameName: roomInfo.gameName,
                hostName: roomInfo.hostName
            });
            updatePlayersDisplay(roomInfo.players || {});
            
            if (roomInfo.gameStarted) {
                gameStarted = true;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('pauseBtn').disabled = false;
                document.getElementById('gameStatus').textContent = 'Game in progress';
            }
        });

        socket.on('room-not-found', () => {
            updateStatus('Game room not found. Redirecting to lobby...', 'error');
            setTimeout(() => {
                window.location.href = '/lobby.html';
            }, 2000);
        });

        socket.on('player-joined', (player) => {
            addToLog(`${player.name} joined the game`, 'system');
            updateStatus(`${player.name} joined!`, 'success');
        });

        socket.on('player-left', (data) => {
            addToLog(`${data.playerName} left the game`, 'system');
            updateStatus(`${data.playerName} left`, 'info');
        });

        socket.on('room-update', (data) => {
            updatePlayersDisplay(data.players || {});
        });

        socket.on('player-action', (data) => {
            const actionText = typeof data.action === 'string' ? data.action : JSON.stringify(data.action);
            addToLog(`${data.playerName}: ${actionText}`, 'player-action');
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus('Connecting to game server...', 'info');
        });
    </script>
</body>
</html>